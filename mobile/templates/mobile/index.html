<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WFM Mobile</title>
    <link rel="manifest" href="/mobile/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #0f172a;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
        }

        .mobile-header {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1e293b;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            color: #94a3b8;
            font-size: 12px;
            text-decoration: none;
            width: 33%;
        }

        .nav-item.active {
            color: #6366f1;
        }

        .nav-item i {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        .card-custom {
            background: #1e293b;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .shift-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
        }

        .shift-date {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .shift-time {
            color: #94a3b8;
            font-size: 14px;
        }

        .shift-badge {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-left: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div class="mobile-header d-flex justify-content-between align-items-center">
        <h5 class="m-0 fw-bold"><i class="bi bi-robot me-2 text-primary"></i>WFM Pro</h5>
        <div class="dropdown">
            <button class="btn btn-sm btn-dark rounded-circle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-fill"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                <li><a class="dropdown-item text-danger" href="/logout/">Çıkış Yap</a></li>
            </ul>
        </div>
    </div>

    <!-- Views -->
    <div id="view-dashboard" class="container pt-3">
        <!-- Welcome Card -->
        <div class="card-custom p-4 bg-gradient-primary"
            style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);">
            <h2 class="fw-bold mb-1" id="user-name">Merhaba!</h2>
            <p class="mb-0 opacity-75">Bugün harika bir iş çıkaracaksın.</p>
        </div>

        <!-- Next Shift -->
        <h6 class="text-muted ms-1 mb-2 text-uppercase" style="font-size: 12px; letter-spacing: 1px;">Sıradaki Vardiya
        </h6>
        <div class="card-custom p-3">
            <div id="next-shift-container">
                <div class="loading">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                </div>
            </div>
        </div>

        <!-- Stats (Admin Only or Personal Stats) -->
        <div id="admin-stats" class="d-none">
            <h6 class="text-muted ms-1 mb-2 text-uppercase" style="font-size: 12px; letter-spacing: 1px;">Operasyon
                Özeti</h6>
            <div class="row g-2">
                <div class="col-6">
                    <div class="card-custom p-3 text-center">
                        <h3 class="fw-bold mb-0 text-info" id="stat-calls">0</h3>
                        <small class="text-muted">Çağrı</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card-custom p-3 text-center">
                        <h3 class="fw-bold mb-0 text-success" id="stat-agents">0</h3>
                        <small class="text-muted">Aktif Agent</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-schedule" class="container pt-3 d-none">
        <h5 class="mb-3 fw-bold ps-1">Vardiya Takvimim</h5>
        <div id="schedule-list" class="card-custom p-0">
            <div class="loading">Yükleniyor...</div>
        </div>
    </div>

    <div id="view-profile" class="container pt-3 d-none">
        <div class="text-center mt-5">
            <div class="display-1 text-muted mb-3"><i class="bi bi-person-circle"></i></div>
            <h3 id="profile-name">Kullanıcı</h3>
            <p class="text-muted" id="profile-role">Rol</p>
            <hr class="border-secondary my-4">
            <a href="/logout/" class="btn btn-outline-danger w-100 py-3 rounded-3">Oturumu Kapat</a>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" onclick="switchView('dashboard', this)">
            <i class="bi bi-grid-fill"></i>
            Ana Sayfa
        </a>
        <a href="#" class="nav-item" onclick="switchView('schedule', this)">
            <i class="bi bi-calendar-range"></i>
            Vardiya
        </a>
        <a href="#" class="nav-item" onclick="switchView('profile', this)">
            <i class="bi bi-person"></i>
            Profil
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Helpers
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (response.status === 403) {
                    window.location.href = '/login/?next=/mobile/';
                    return null;
                }
                return await response.json();
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        // Views
        function switchView(viewName, el) {
            // Update Tab UI
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            // Show Content
            ['dashboard', 'schedule', 'profile'].forEach(v => {
                document.getElementById('view-' + v).classList.add('d-none');
            });
            document.getElementById('view-' + viewName).classList.remove('d-none');

            // Refresh Data if needed
            if (viewName === 'schedule') loadSchedule();
        }

        // Logic
        async function init() {
            // Load Dashboard
            const stats = await fetchAPI('/mobile/api/dashboard/stats/');
            if (stats) {
                document.getElementById('user-name').innerText = `Merhaba, ${stats.username}`;
                document.getElementById('profile-name').innerText = stats.username;

                // Next Shift
                const ns = stats.next_shift;
                const nsContainer = document.getElementById('next-shift-container');
                if (ns) {
                    nsContainer.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="me-3 bg-secondary bg-opacity-10 p-3 rounded-circle text-warning">
                                <i class="bi bi-clock-history fs-4"></i>
                            </div>
                            <div>
                                <h5 class="mb-0 fw-bold">${ns.date}</h5>
                                <small class="text-primary">${ns.type}</small>
                            </div>
                        </div>
                    `;
                } else {
                    nsContainer.innerHTML = `<p class="mb-0 text-muted">Planlanmış vardiya bulunamadı.</p>`;
                }
            }

            // Check Admin Stats
            const adminData = await fetchAPI('/mobile/api/admin/daily_summary/');
            if (adminData && adminData.total_calls !== undefined) {
                document.getElementById('admin-stats').classList.remove('d-none');
                document.getElementById('stat-calls').innerText = adminData.total_calls;
                document.getElementById('stat-agents').innerText = adminData.active_agents;
            }
        }

        async function loadSchedule() {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '<div class="loading"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

            const shifts = await fetchAPI('/mobile/api/shifts/');
            if (shifts && shifts.results) {
                if (shifts.results.length === 0) {
                    list.innerHTML = '<div class="p-4 text-center text-muted">Vardiya bulunamadı.</div>';
                    return;
                }

                let html = '';
                shifts.results.forEach(s => {
                    html += `
                        <div class="shift-item">
                            <div>
                                <div class="shift-date">${s.date}</div>
                                <div class="shift-time"><i class="bi bi-clock me-1"></i>${s.start_time} Başlangıç</div>
                            </div>
                            <div class="shift-badge">${s.shift_name}</div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            }
        }

        // Start
        init();
    </script>
</body>

</html>
{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Tahminleme & Planlama</h2>
    <div class="d-flex gap-2">
        <form method="get" class="d-flex gap-2">
            <!-- Filter by Queue -->
            <select name="queue_id" class="form-select bg-dark text-white border-secondary"
                onchange="this.form.submit()">
                <option value="">Tüm Kuyruklar</option>
                {% for q in queues %}
                <option value="{{ q.id }}" {% if selected_queue_id == q.id %}selected{% endif %}>{{ q.name }}</option>
                {% endfor %}
            </select>

            <input type="date" name="start_date" value="{{ start_date }}"
                class="form-control bg-dark text-white border-secondary" style="width: auto;">
            <input type="date" name="end_date" value="{{ end_date }}"
                class="form-control bg-dark text-white border-secondary" style="width: auto;">

            <button type="submit" class="btn btn-primary">
                <i class="bi bi-filter"></i>
            </button>
        </form>

        <form method="post" class="d-flex gap-2">
            {% csrf_token %}
            <input type="hidden" name="queue_id" value="{{ selected_queue_id|default:'' }}">
            <input type="hidden" name="start_date" value="{{ start_date }}">
            <input type="hidden" name="end_date" value="{{ end_date }}">

            <!-- Model Selection -->
            <select name="forecast_model" class="form-select bg-dark text-white border-secondary" style="width: auto;">
                <option value="simple_avg">Basit Ortalama</option>
                <option value="weighted_avg">Ağırlıklı Ortalama (Son 4 Hafta)</option>
                <option value="erlang_c" disabled>Erlang C (Otomatik Kullanımda)</option>
            </select>

            <button type="submit" name="update_actuals" class="btn btn-outline-info">
                <i class="bi bi-arrow-clockwise"></i> Verileri Güncelle
            </button>
            <button type="submit" name="generate_forecast" class="btn btn-warning">
                <i class="bi bi-graph-up"></i> Tahmin Oluştur
            </button>
            <button type="submit" name="run_schedule" class="btn btn-success">
                <i class="bi bi-calendar-check"></i> Planla & Git
            </button>
        </form>
    </div>
</div>

<script>
    // Prevent Past Dates in DatePickers
    document.addEventListener('DOMContentLoaded', function () {
        var today = new Date().toISOString().split('T')[0];
        document.getElementsByName("start_date")[0].setAttribute('min', today);
        document.getElementsByName("end_date")[0].setAttribute('min', today);
    });
</script>

<p class="text-muted">Dönem: {{ start_date }} - {{ end_date }}</p>

<!-- Controls -->
<div class="d-flex justify-content-end mb-2">
    <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="chartType" id="typeLine" autocomplete="off" checked
            onchange="setChartType('line')">
        <label class="btn btn-outline-secondary btn-sm" for="typeLine"><i class="bi bi-graph-up"></i> Çizgi</label>

        <input type="radio" class="btn-check" name="chartType" id="typeBar" autocomplete="off"
            onchange="setChartType('bar')">
        <label class="btn btn-outline-secondary btn-sm" for="typeBar"><i class="bi bi-bar-chart"></i> Sütun</label>
    </div>
</div>

<div class="card p-4">
    <canvas id="forecastChart" style="max-height: 400px;"></canvas>
</div>

<!-- Data Passing -->
{{ labels|json_script:"chart-labels" }}
{{ actual_data|json_script:"chart-actuals" }}
{{ forecast_data|json_script:"chart-forecast" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = JSON.parse(document.getElementById('chart-labels').textContent);
    const actuals = JSON.parse(document.getElementById('chart-actuals').textContent);
    const forecasts = JSON.parse(document.getElementById('chart-forecast').textContent);

    const ctx = document.getElementById('forecastChart');

    // Assign to window for access
    window.myForecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Gerçekleşen',
                    data: actuals,
                    borderColor: '#06b6d4', // Cyan
                    backgroundColor: 'rgba(6, 182, 212, 0.5)', // More opacity for bar
                    tension: 0.3,
                    pointRadius: 2,
                    borderWidth: 2
                },
                {
                    label: 'Tahmin (Forecast)',
                    data: forecasts,
                    borderColor: '#a855f7', // Purple
                    backgroundColor: 'rgba(168, 85, 247, 0.5)',
                    borderDash: [5, 5],
                    tension: 0.3,
                    pointRadius: 2,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Çağrı Hacmi: Gerçekleşen vs Tahmin' }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { display: false } }
            }
        }
    });

    function setChartType(type) {
        window.myForecastChart.config.type = type;

        // Adjust style slightly for bars if needed
        if (type === 'bar') {
            window.myForecastChart.data.datasets.forEach(ds => {
                ds.borderWidth = 0; // Remove border for cleaner bar look? Or keep it.
                ds.borderRadius = 3;
            });
        } else {
            window.myForecastChart.data.datasets.forEach(ds => {
                ds.borderWidth = 2;
                ds.borderRadius = 0;
            });
        }

        window.myForecastChart.update();
    }
</script>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Canlı Takım İzleme (RTA)</h2>
        <p class="text-muted">Ajanların anlık durumlarını ve vardiya uyumlarını takip edin.</p>
    </div>
    <div>
        <span class="badge bg-success me-2">Uyumlu</span>
        <span class="badge bg-danger">Uyumsuz</span>
        <button class="btn btn-outline-primary ms-3" onclick="loadData()">
            <i class="bi bi-arrow-clockwise"></i> Yenile
        </button>
    </div>
</div>

<div class="row" id="agent-grid">
    <!-- Cards will be injected here via JS -->
    {% for agent in initial_data %}
    <div class="col-md-3 col-sm-6 mb-4 agent-card-wrapper">
        <div
            class="card h-100 border-start border-5 {% if agent.is_adherent %}border-success{% else %}border-danger{% endif %}">
            <div class="card-body text-center">
                <div class="mb-3">
                    <div class="avatar-placeholder rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto text-white fs-4"
                        style="width: 60px; height: 60px;">
                        {{ agent.agent_name|slice:":1" }}
                    </div>
                </div>
                <h5 class="card-title">{{ agent.agent_name }}</h5>
                <p class="text-muted small mb-1">{{ agent.team }}</p>

                <div class="d-flex justify-content-center gap-2 mt-3">
                    <div class="badge bg-dark p-2">
                        <small class="d-block text-muted" style="font-size: 0.6rem;">CANLI</small>
                        <span class="fw-bold">{{ agent.live_state }}</span>
                    </div>
                    <div class="badge bg-light text-dark border p-2">
                        <small class="d-block text-muted" style="font-size: 0.6rem;">PLAN</small>
                        <span class="fw-bold">{{ agent.scheduled_state }}</span>
                    </div>
                </div>

                <div class="mt-3 text-muted small">
                    Süre: <strong>{{ agent.duration_str }}</strong>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function loadData() {
        const grid = document.getElementById('agent-grid');

        fetch("{% url 'rta_view' %}", {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(response => response.json())
            .then(data => {
                let html = '';
                data.agents.forEach(agent => {
                    const borderClass = agent.is_adherent ? 'border-success' : 'border-danger';
                    const initial = agent.agent_name.charAt(0);

                    html += `
                <div class="col-md-3 col-sm-6 mb-4 agent-card-wrapper">
                    <div class="card h-100 border-start border-5 ${borderClass}">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <div class="avatar-placeholder rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto text-white fs-4" style="width: 60px; height: 60px;">
                                    ${initial}
                                </div>
                            </div>
                            <h5 class="card-title">${agent.agent_name}</h5>
                            <p class="text-muted small mb-1">${agent.team}</p>
                            
                            <div class="d-flex justify-content-center gap-2 mt-3">
                                <div class="badge bg-dark p-2">
                                    <small class="d-block text-muted" style="font-size: 0.6rem;">CANLI</small>
                                    <span class="fw-bold">${agent.live_state}</span>
                                </div>
                                <div class="badge bg-light text-dark border p-2">
                                    <small class="d-block text-muted" style="font-size: 0.6rem;">PLAN</small>
                                    <span class="fw-bold">${agent.scheduled_state}</span>
                                </div>
                            </div>
                            
                            <div class="mt-3 text-muted small">
                                Süre: <strong>${agent.duration_str}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                });
                grid.innerHTML = html;
            });
    }

    // Auto-refresh every 10 seconds
    setInterval(loadData, 10000);
</script>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Haftalık Vardiya Planı</h2>
    <form method="post">
        {% csrf_token %}
        <button type="submit" name="generate" class="btn btn-outline-light"><i class="bi bi-arrow-repeat"></i> Planı
            Yenile</button>
    </form>
</div>

<!-- Filter Form -->
<form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-md-3">
        <label class="form-label small text-muted">Başlangıç Tarihi</label>
        <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
    </div>
    <div class="col-md-3">
        <label class="form-label small text-muted">Bitiş Tarihi</label>
        <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
    </div>
    <div class="col-md-3">
        <label class="form-label small text-muted">Agent Ara</label>
        <input type="text" name="q" class="form-control" placeholder="İsim..." value="{{ request.GET.q }}">
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Filtrele</button>
    </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-2">
    <p class="text-muted mb-0 small"><i class="bi bi-calendar-range"></i> {{ start_date }} - {{ end_date }}</p>
    {% if request.GET.q or request.GET.start_date %}
    <a href="{% url 'schedule' %}" class="btn btn-sm btn-outline-secondary">Filtreleri Temizle</a>
    {% endif %}
</div>

<div class="table-responsive card p-2">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th>Agent</th>
                {% for d in week_dates %}
                <th>{{ d|date:"D d M" }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in schedule_table %}
            <tr>
                <td>{{ row.agent.user.username }}<br><small class="text-muted">{{ row.agent.team }}</small></td>
                {% for shift in row.shifts %}
                <td>
                    {% if shift %}
                    <div role="button" tabindex="0"
                        class="shift-cell p-1 rounded border border-secondary position-relative"
                        onclick="openShiftModal(this)" data-shift-name="{{ shift.shift_name }}"
                        data-start="{{ shift.start_time|time:'H:i' }}" data-end="{{ shift.end_time|time:'H:i' }}"
                        data-activities='[
                            {% for act in shift.activities.all %}
                            {
                                "type": "{{ act.get_activity_type_display }}",
                                "start": "{{ act.start_time|time:' H:i' }}", "end" : "{{ act.end_time|time:'H:i' }}"
                        , "raw_type" : "{{ act.activity_type }}" }{% if not forloop.last %},{% endif %} {% endfor %} ]'>

                        <!-- Visible Content -->
                        <span
                            class="badge bg-{% if shift.shift_name == 'Sabah' %}warning{% elif shift.shift_name == 'Öğlen' %}info{% else %}primary{% endif %} text-dark w-100">
                            {{ shift.shift_name }}
                        </span>
                        <div class="small mt-1">
                            {{ shift.start_time|time:"H:i" }} - {{ shift.end_time|time:"H:i" }}
                        </div>
                    </div>
                    {% else %}
                    <span class="text-muted opacity-50">-</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted small">
        Toplam {{ page_obj.paginator.count }} Agent. Sayfa {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}.
    </div>
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                    href="?page={{ page_obj.previous_page_number }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&q={{ request.GET.q }}">Önceki</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Önceki</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item">
                <a class="page-link"
                    href="?page={{ num }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&q={{ request.GET.q }}">{{num }}</a>
                    
                </li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="?page={{ page_obj.next_page_number }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&q={{ request.GET.q }}">Sonraki</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Sonraki</span></li>
                {% endif %}
        </ul>
    </nav>
</div>

<!-- Shift Detail Modal -->
<div class="modal fade" id="shiftDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shiftDetailTitle">Vardiya Detayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="shiftTimeRange" class="mb-3 text-muted"></h6>
                <div class="list-group" id="activityList">
                    <!-- JS will populate -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openShiftModal(element) {
        // Extract data
        const name = element.getAttribute('data-shift-name');
        const start = element.getAttribute('data-start');
        const end = element.getAttribute('data-end');

        let activities = [];
        try {
            // Replace None/Python weirdness if any, though Django template usually handles it.
            // We used standard JSON syntax in the template loop.
            activities = JSON.parse(element.getAttribute('data-activities'));
        } catch (e) {
            console.error("Error parsing activities", e);
        }

        // Populate Modal
        document.getElementById('shiftDetailTitle').textContent = name + ' Vardiyası Detayları';
        document.getElementById('shiftTimeRange').textContent = 'Saat: ' + start + ' - ' + end;

        const list = document.getElementById('activityList');
        list.innerHTML = '';

        if (activities.length === 0) {
            list.innerHTML = '<div class="text-center text-muted p-3">Aktivite detayı bulunamadı.</div>';
        } else {
            activities.forEach(act => {
                let colorClass = 'list-group-item-secondary';
                if (act.raw_type === 'WORK') colorClass = 'list-group-item-success';
                else if (act.raw_type === 'LUNCH') colorClass = 'list-group-item-warning';

                const item = document.createElement('div');
                item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${colorClass}`;
                item.innerHTML = `
                    <span><strong>${act.type}</strong></span>
                    <span class="badge bg-secondary rounded-pill">${act.start} - ${act.end}</span>
                `;
                list.appendChild(item);
            });
        }

        // Show Modal
        new bootstrap.Modal(document.getElementById('shiftDetailModal')).show();
    }
</script>
{% endblock %}